import { rsi } from "technicalindicators";
import { Interval } from "../domain/Interval";
import { Strategy, type StrategyResponse } from "../domain/Strategy";

export const stg = new Strategy({
	stgName: "rsiDivergency15m",
	lookBackLength: 200,
	interval: Interval["15m"],
	allowedPairs:[],

	validate({ candlestick, pair }) {
		const response: StrategyResponse = {
			positionSide: null,
			stgName: this.stgName,
			pair,
		};

		if (candlestick.length < this.lookBackLength) return response;
		if (this.allowedPairs?.length && !this.allowedPairs.includes(pair))
			return response;

		const MIN_RSI = 30;
		const CANDLESTICK_SIZE = 50;

		const closePrices = candlestick.map((candle) => candle.close);
		const rsiArray = rsi({ period: 14, values: closePrices });

		let candlestickValues: number[] = [];

		candlestick.forEach(({ close, high, low, open }) => {
			candlestickValues.push(close, high, low, open);
		});

		const lastPrice = candlestickValues[candlestickValues.length - 1];

		if (
			rsiArray[rsiArray.length - 1] <= MIN_RSI &&
			rsiArray[rsiArray.length - 2] <= MIN_RSI &&
			rsiArray[rsiArray.length - 1] > rsiArray[rsiArray.length - 2]
		) {
			const firstZeroCrossingIndex = [...rsiArray]
				.reverse()
				.findIndex((arrayVal) => arrayVal > MIN_RSI);

			const firstRange = rsiArray.slice(-firstZeroCrossingIndex);
			const secondRange = rsiArray.slice(
				rsiArray.length - CANDLESTICK_SIZE,
				rsiArray.length - firstZeroCrossingIndex
			);

			const firstMin = Math.min(
				...firstRange.map((value) => Number(value) || 0)
			);
			const secondMin = Math.min(
				...secondRange.map((value) => Number(value) || 0)
			);

			if (firstMin !== 0 && secondMin !== 0 && firstMin > secondMin) {
				const minPrevPrice = Math.min(
					...candlestick.slice(-CANDLESTICK_SIZE).map((candle) => candle.low)
				);
				let sl = (lastPrice - minPrevPrice) / lastPrice;

				response.positionSide = "LONG";
				response.sl = sl;
			}
		}

		if (
			rsiArray[rsiArray.length - 1] >= 100 - MIN_RSI &&
			rsiArray[rsiArray.length - 2] >= 100 - MIN_RSI &&
			rsiArray[rsiArray.length - 1] < rsiArray[rsiArray.length - 2]
		) {
			const firstZeroCrossingIndex = [...rsiArray]
				.reverse()
				.findIndex((arrayVal) => arrayVal < 100 - MIN_RSI);

			const firstRange = rsiArray.slice(-firstZeroCrossingIndex);
			const secondRange = rsiArray.slice(
				rsiArray.length - CANDLESTICK_SIZE,
				rsiArray.length - firstZeroCrossingIndex
			);

			const firstMax = Math.max(
				...firstRange.map((value) => Number(value) || 0)
			);
			const secondMax = Math.max(
				...secondRange.map((value) => Number(value) || 0)
			);

			if (firstMax !== 0 && secondMax !== 0 && firstMax < secondMax) {
				const maxPrevPrice = Math.max(
					...candlestick.slice(-CANDLESTICK_SIZE).map((candle) => candle.high)
				);

				let sl = (maxPrevPrice - lastPrice) / lastPrice;

				response.sl = sl;
				response.positionSide = "SHORT";
			}
		}

		return response;
	},
});

// Stats summary:
// ┌────┬─────────────────────┬───────────────────┬──────────────────────┬──────────────────────┬──────────────────────────┬────────────┬────────────────┬───────┐
// │    │ SL TPSLRatio MaxLen │ QTY ps wp acc fwd │ WINRATE wp acc fwd   │ AVPNL wp acc fwd     │ ACCPNL wp acc fwd        │ DD badRun  │ PerDay pnl Qty │ pairs │
// ├────┼─────────────────────┼───────────────────┼──────────────────────┼──────────────────────┼──────────────────────────┼────────────┼────────────────┼───────┤
// │  0 │ 10.00% 15 100       │ 7893 3755 515 173 │ 45.65% 44.08% 41.62% │ -0.03% 0.01% -0.35%  │ -123.47% 5.78% -59.74%   │ 81.16% 10  │ 0.01%  0.83    │ 28    │
// │  1 │ 10.00% 12 100       │ 7893 3755 515 173 │ 45.67% 44.08% 41.62% │ -0.04% 0.01% -0.35%  │ -133.21% 3.56% -59.74%   │ 78.38% 9   │ 0.01%  0.83    │ 28    │
// │  2 │ 10.00% 9 100        │ 7893 3755 517 174 │ 45.70% 44.10% 41.95% │ -0.04% 0.00% -0.27%  │ -142.10% 2.19% -47.27%   │ 80.44% 8   │ 0.00%  0.83    │ 28    │
// │  3 │ 10.00% 5 100        │ 7893 3755 524 176 │ 45.83% 44.27% 43.18% │ -0.06% -0.01% -0.24% │ -206.83% -6.38% -41.68%  │ 82.98% 8   │ -0.01%  0.84   │ 28    │
// │  4 │ 15.00% 15 100       │ 7893 3755 512 169 │ 45.83% 44.14% 42.60% │ -0.03% -0.02% -0.35% │ -117.57% -9.07% -59.83%  │ 88.32% 11  │ -0.01%  0.82   │ 28    │
// │  5 │ 15.00% 12 100       │ 7893 3755 512 169 │ 45.86% 44.14% 42.60% │ -0.03% -0.02% -0.35% │ -127.31% -11.29% -59.83% │ 89.33% 7   │ -0.02%  0.82   │ 28    │
// │  6 │ 15.00% 9 100        │ 7893 3755 514 170 │ 45.89% 43.97% 42.94% │ -0.04% -0.03% -0.28% │ -136.19% -13.04% -47.36% │ 91.05% 10  │ -0.02%  0.83   │ 28    │
// │  7 │ 7.00% 15 100        │ 7893 3755 540 183 │ 44.71% 43.15% 42.62% │ -0.05% -0.03% -0.16% │ -186.50% -14.51% -29.98% │ 91.80% 9   │ -0.02%  0.87   │ 28    │
// │  8 │ 7.00% 12 100        │ 7893 3755 540 183 │ 44.74% 43.15% 42.62% │ -0.05% -0.03% -0.18% │ -196.24% -14.52% -32.40% │ 92.89% 10  │ -0.02%  0.87   │ 28    │
// │  9 │ 7.00% 9 100         │ 7893 3755 543 184 │ 44.77% 43.09% 42.93% │ -0.05% -0.03% -0.12% │ -190.55% -16.34% -22.35% │ 92.93% 14  │ -0.03%  0.87   │ 28    │
// │ 10 │ 7.00% 1 100         │ 7893 3755 604 203 │ 52.92% 52.32% 49.75% │ -0.04% -0.03% -0.20% │ -149.78% -17.25% -39.76% │ 79.53% 9   │ -0.03%  0.97   │ 28    │
// │ 11 │ 10.00% 1 100        │ 7893 3755 562 181 │ 53.29% 52.31% 49.17% │ -0.04% -0.04% -0.25% │ -165.75% -22.15% -45.57% │ 85.93% 9   │ -0.04%  0.90   │ 28    │
// │ 12 │ 10.00% 2 100        │ 7893 3755 545 179 │ 48.34% 47.16% 45.81% │ -0.06% -0.04% -0.22% │ -222.73% -22.17% -39.15% │ 89.16% 13  │ -0.04%  0.88   │ 28    │
// │ 13 │ 15.00% 5 100        │ 7893 3755 523 171 │ 46.02% 43.98% 43.27% │ -0.06% -0.04% -0.33% │ -209.31% -22.49% -56.95% │ 91.78% 10  │ -0.04%  0.84   │ 28    │
// │ 14 │ 20.00% 15 100       │ 7893 3755 510 164 │ 45.83% 44.12% 44.51% │ -0.04% -0.05% -0.23% │ -138.55% -23.05% -37.87% │ 100.16% 8  │ -0.04%  0.82   │ 28    │
// │ 15 │ 15.00% 2 100        │ 7893 3755 537 173 │ 48.52% 46.93% 46.24% │ -0.06% -0.05% -0.31% │ -217.90% -24.90% -53.59% │ 91.73% 7   │ -0.04%  0.86   │ 28    │
// │ 16 │ 20.00% 12 100       │ 7893 3755 510 164 │ 45.86% 44.12% 44.51% │ -0.04% -0.05% -0.23% │ -148.29% -25.26% -37.87% │ 99.52% 8   │ -0.04%  0.82   │ 28    │
// │ 17 │ 20.00% 9 100        │ 7893 3755 512 165 │ 45.89% 43.95% 44.85% │ -0.04% -0.05% -0.15% │ -157.18% -27.01% -25.41% │ 101.32% 13 │ -0.04%  0.82   │ 28    │
// │ 18 │ 7.00% 5 100         │ 7893 3755 553 186 │ 44.90% 43.40% 44.09% │ -0.07% -0.05% -0.10% │ -277.00% -27.75% -19.43% │ 94.19% 12  │ -0.04%  0.89   │ 28    │
// │ 19 │ 15.00% 1 100        │ 7893 3755 540 176 │ 53.37% 51.67% 48.86% │ -0.04% -0.06% -0.28% │ -144.03% -32.70% -48.77% │ 92.32% 10  │ -0.05%  0.87   │ 28    │
// │ 20 │ 20.00% 5 100        │ 7893 3755 521 166 │ 46.02% 43.95% 45.18% │ -0.06% -0.08% -0.21% │ -230.30% -41.30% -35.00% │ 106.72% 8  │ -0.07%  0.84   │ 28    │
// │ 21 │ 7.00% 2 100         │ 7893 3755 578 191 │ 47.46% 46.02% 45.03% │ -0.07% -0.08% -0.18% │ -254.17% -45.10% -34.97% │ 100.18% 8  │ -0.07%  0.93   │ 28    │
// │ 22 │ 20.00% 2 100        │ 7893 3755 533 169 │ 48.52% 46.72% 47.93% │ -0.06% -0.08% -0.19% │ -243.44% -45.17% -31.96% │ 105.77% 8  │ -0.07%  0.86   │ 28    │
// │ 23 │ 20.00% 1 100        │ 7893 3755 539 173 │ 53.34% 51.76% 49.71% │ -0.05% -0.10% -0.18% │ -202.59% -55.30% -31.01% │ 110.97% 9  │ -0.09%  0.87   │ 28    │
// └────┴─────────────────────┴───────────────────┴──────────────────────┴──────────────────────┴──────────────────────────┴────────────┴────────────────┴───────┘
// Stats per pair
// ┌────┬──────────────┬─────┬────────┬──────────┬─────────┬────────────┬─────────┬───────────┬─────────────┐
// │    │ pair         │ qty │ avPnl  │ avPnlAcc │ winRate │ winRateAcc │ accPnl  │ accPnlAcc │ drawdownAcc │
// ├────┼──────────────┼─────┼────────┼──────────┼─────────┼────────────┼─────────┼───────────┼─────────────┤
// │  0 │ 1000LUNCUSDT │ 126 │ 0.44%  │ 0.47%    │ 50.79%  │ 50.60%     │ 55.79%  │ 39.06%    │ 18.68%      │
// │  1 │ ALGOUSDT     │ 139 │ 0.32%  │ 0.45%    │ 47.48%  │ 49.44%     │ 44.23%  │ 40.17%    │ 18.91%      │
// │  2 │ ALICEUSDT    │ 115 │ 0.27%  │ 0.41%    │ 53.04%  │ 50.68%     │ 31.01%  │ 29.99%    │ 17.39%      │
// │  3 │ XMRUSDT      │ 133 │ 0.40%  │ 0.40%    │ 61.65%  │ 56.72%     │ 53.43%  │ 26.89%    │ 10.13%      │
// │  4 │ HOOKUSDT     │ 110 │ 0.14%  │ 0.23%    │ 44.55%  │ 48.68%     │ 14.94%  │ 17.47%    │ 21.57%      │
// │  5 │ SFPUSDT      │ 135 │ 0.18%  │ 0.20%    │ 55.56%  │ 56.25%     │ 24.46%  │ 16.13%    │ 18.36%      │
// │  6 │ C98USDT      │ 122 │ 0.03%  │ 0.14%    │ 44.26%  │ 48.10%     │ 3.56%   │ 11.18%    │ 24.31%      │
// │  7 │ VETUSDT      │ 121 │ 0.05%  │ 0.14%    │ 47.93%  │ 49.32%     │ 6.25%   │ 10.07%    │ 21.07%      │
// │  8 │ FXSUSDT      │ 150 │ 0.08%  │ 0.14%    │ 47.33%  │ 50.60%     │ 12.72%  │ 11.40%    │ 25.14%      │
// │  9 │ ENSUSDT      │ 119 │ 0.21%  │ 0.14%    │ 57.14%  │ 54.29%     │ 25.53%  │ 9.55%     │ 27.13%      │
// │ 10 │ APEUSDT      │ 142 │ -0.10% │ 0.13%    │ 46.48%  │ 50.57%     │ -14.68% │ 11.45%    │ 31.72%      │
// │ 11 │ ICXUSDT      │ 130 │ -0.09% │ 0.10%    │ 46.92%  │ 49.43%     │ -12.30% │ 8.88%     │ 26.70%      │
// │ 12 │ MASKUSDT     │ 152 │ 0.04%  │ 0.10%    │ 38.82%  │ 37.89%     │ 5.93%   │ 9.03%     │ 37.51%      │
// │ 13 │ XRPUSDT      │ 123 │ 0.01%  │ 0.08%    │ 51.22%  │ 50.65%     │ 0.89%   │ 6.28%     │ 19.21%      │
// │ 14 │ ATAUSDT      │ 119 │ -0.25% │ 0.08%    │ 40.34%  │ 48.05%     │ -29.37% │ 6.01%     │ 32.20%      │
// │ 15 │ MKRUSDT      │ 171 │ -0.15% │ 0.03%    │ 41.52%  │ 40.43%     │ -25.49% │ 2.68%     │ 28.76%      │
// │ 16 │ ADAUSDT      │ 130 │ 0.11%  │ 0.03%    │ 52.31%  │ 50.00%     │ 14.06%  │ 2.14%     │ 23.21%      │
// │ 17 │ LUNA2USDT    │ 105 │ 0.13%  │ 0.01%    │ 40.95%  │ 43.06%     │ 13.76%  │ 0.91%     │ 33.54%      │
// │ 18 │ TRUUSDT      │ 134 │ -0.27% │ -0.06%   │ 35.82%  │ 37.84%     │ -36.31% │ -4.54%    │ 42.32%      │
// │ 19 │ GMXUSDT      │ 139 │ -0.08% │ -0.08%   │ 45.32%  │ 45.57%     │ -11.58% │ -6.22%    │ 35.48%      │
// │ 20 │ TUSDT        │ 109 │ -0.35% │ -0.08%   │ 45.87%  │ 52.31%     │ -38.63% │ -5.30%    │ 34.34%      │
// │ 21 │ NEOUSDT      │ 162 │ -0.03% │ -0.09%   │ 46.30%  │ 46.15%     │ -5.40%  │ -7.96%    │ 37.20%      │
// │ 22 │ LRCUSDT      │ 109 │ -0.12% │ -0.12%   │ 45.87%  │ 46.75%     │ -13.56% │ -9.31%    │ 32.69%      │
// │ 23 │ 1000SHIBUSDT │ 136 │ -0.02% │ -0.22%   │ 46.32%  │ 39.33%     │ -2.25%  │ -19.43%   │ 46.67%      │
// │ 24 │ KAVAUSDT     │ 198 │ -0.43% │ -0.31%   │ 41.92%  │ 42.39%     │ -86.08% │ -28.35%   │ 46.42%      │
// │ 25 │ RSRUSDT      │ 161 │ -0.17% │ -0.33%   │ 42.24%  │ 34.62%     │ -27.45% │ -34.15%   │ 54.13%      │
// │ 26 │ STXUSDT      │ 149 │ -0.30% │ -0.55%   │ 34.23%  │ 35.00%     │ -45.19% │ -43.67%   │ 57.93%      │
// │ 27 │ LINAUSDT     │ 116 │ -0.70% │ -0.63%   │ 31.03%  │ 26.67%     │ -81.76% │ -47.53%   │ 62.86%      │
// └────┴──────────────┴─────┴────────┴──────────┴─────────┴────────────┴─────────┴───────────┴─────────────┘
